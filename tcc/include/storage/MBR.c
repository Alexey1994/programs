#ifndef MBR_STORAGE
#define MBR_STORAGE


#include <file.c>
#include <memory.c>


Byte bootcode[] = {
	0x8C, 0xC8, 0x8E, 0xD8, 0x8E, 0xD0, 0x8E, 0xC0, 0xFC, 0xBE, 0x1E, 0x7C, 0xBF, 0x00, 0x7E, 0xB8, 
	0x32, 0x00, 0x83, 0xF8, 0x00, 0x74, 0x04, 0xA4, 0x48, 0xEB, 0xF7, 0xE9, 0xE2, 0x01, 0xB4, 0x42, 
	0xB2, 0x80, 0xBE, 0x22, 0x7E, 0xCD, 0x13, 0x72, 0x05, 0xEA, 0x00, 0x7C, 0x00, 0x00, 0xB8, 0x00, 
	0xB8, 0x8E, 0xD8, 0xB0, 0x01, 0xB4, 0x0C, 0xBB, 0x00, 0x00, 0x3E, 0x89, 0x07, 0xF4, 0xEB, 0xFE, 
	0x10, 0x00, 0x01, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


typedef struct
{
	Byte     active; //0 - no active, 0x80 - active
	Number8  start_head_in_CHS;
	Number8  start_sector_in_CHS;
	Number8  start_cylinder_in_CHS;
	Byte     type;   //0x0C - FAT32
	Number8  end_head_in_CHS;
	Number8  end_sector_in_CHS;
	Number8  end_cylinder_in_CHS;
	Number32 start_sector_in_LBA;
	Number32 size_in_LBA;
}
MBR;


void create_partition(File storage_file, Number64 storage_file_size)
{
	Byte sector[512] = {0};
	MBR* partition;

	clear_bytes(sector, 512);
	copy_bytes(sector, bootcode, sizeof(bootcode));

	partition = sector + 446;
	partition->active                = 0x80;
	partition->type                  = 0x0C;
	partition->start_head_in_CHS     = 1;
	partition->start_sector_in_CHS   = 1;
	partition->start_cylinder_in_CHS = 0;
	partition->end_head_in_CHS       = 0xFE;
	partition->end_sector_in_CHS     = 0xFF;
	partition->end_cylinder_in_CHS   = 0xFF;
	partition->start_sector_in_LBA   = 1;
	partition->size_in_LBA           = storage_file_size / 512 - 1;

	sector[510] = 0x55;
	sector[511] = 0xAA;

	write_in_file(storage_file, 0, sector, 512);
}


#endif//MBR_STORAGE